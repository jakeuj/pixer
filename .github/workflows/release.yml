name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v0.0.2)'
        required: true
        default: 'v0.0.2'

permissions:
  contents: write
  actions: read

jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest, macos-latest]
        include:
          - os: windows-latest
            platform: win32
            arch: x64
            ext: .exe
            python_cmd: python
          - os: macos-latest
            platform: darwin
            arch: x64
            ext: ''
            python_cmd: python3

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          ${{ matrix.python_cmd }} -m pip install --upgrade pip
          ${{ matrix.python_cmd }} -m pip install Pillow PyInstaller

      - name: Install Node.js dependencies
        run: npm install

      - name: Create Python standalone executable
        run: |
          # å»ºç«‹ Python ç¨ç«‹åŸ·è¡Œæª”
          pyinstaller --onefile --distpath ./python-dist --name upload upload.py
          pyinstaller --onefile --distpath ./python-dist --name firmware_upgrade firmware_upgrade.py





      - name: Build Electron app
        run: npm run build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pixer-controller-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            dist/*.exe
            dist/*.dmg
            dist/*.AppImage
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -la artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.version || github.ref_name }}
          name: Pixer Controller ${{ github.event.inputs.version || github.ref_name }}
          body: |
            ## Pixer Controller Release ${{ github.event.inputs.version || github.ref_name }}

            ### åŠŸèƒ½ç‰¹è‰²
            - ğŸ–¼ï¸ åœ–å½¢åŒ–ä½¿ç”¨è€…ä»‹é¢
            - ğŸ“± è£ç½®ç‹€æ…‹æª¢æŸ¥ï¼ˆé›»æ± é›»é‡ã€éŸŒé«”ç‰ˆæœ¬ç­‰ï¼‰
            - ğŸ”„ åœ–ç‰‡ä¸Šå‚³èˆ‡é€²åº¦é¡¯ç¤º
            - ğŸ”§ å›ºä»¶å‡ç´šåŠŸèƒ½
            - ğŸ”„ è£ç½®é‡ç½®åŠŸèƒ½
            - ğŸ“ å³æ™‚æ“ä½œæ—¥èªŒ

            ### å®‰è£èªªæ˜

            #### Windows 11 x64
            1. ä¸‹è¼‰ `Pixer-Controller-Setup-*.exe`
            2. åŸ·è¡Œå®‰è£ç¨‹å¼
            3. å®Œæˆå®‰è£å¾Œå³å¯ä½¿ç”¨

            #### macOS
            1. ä¸‹è¼‰ `Pixer-Controller-*.dmg`
            2. é–‹å•Ÿ DMG æª”æ¡ˆ
            3. å°‡æ‡‰ç”¨ç¨‹å¼æ‹–æ‹½åˆ° Applications è³‡æ–™å¤¾
            4. é¦–æ¬¡åŸ·è¡Œæ™‚å¯èƒ½éœ€è¦åœ¨ç³»çµ±åå¥½è¨­å®šä¸­å…è¨±åŸ·è¡Œ

            ### ä½¿ç”¨æ–¹å¼
            1. ç¢ºä¿ Pixer è£ç½®å·²é–‹æ©Ÿä¸¦å»ºç«‹ WiFi ç†±é»
            2. å°‡é›»è…¦é€£æ¥åˆ° Pixer çš„ WiFi ç†±é»
            3. å•Ÿå‹• Pixer Controller
            4. é»æ“Šã€Œæª¢æŸ¥è£ç½®ã€ç¢ºèªé€£ç·š
            5. é¸æ“‡åœ–ç‰‡ä¸¦ä¸Šå‚³åˆ°è£ç½®

            ### ç³»çµ±éœ€æ±‚
            - Windows 11 x64 æˆ– macOS 10.14+
            - ç„¡éœ€é¡å¤–å®‰è£ Python æˆ–å…¶ä»–ä¾è³´
          draft: false
          prerelease: false
          files: |
            artifacts/pixer-controller-win32-x64/*.exe
            artifacts/pixer-controller-darwin-x64/*.dmg
          fail_on_unmatched_files: false
